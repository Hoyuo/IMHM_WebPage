<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mybatis/mapper.xml">

    <insert id="register" parameterType="DB.DTO.UserDTO">
        insert into  [dbo].[User]
           ([Username]
           ,[Password]
           ,[UUID]
           ,[LastLogin]
           ,[Nick])
           VALUES
            (#{id},#{pw},'test',getDate(),#{nick});
    </insert>

    <select id="login" parameterType="DB.DTO.UserInfoDTO" resultType="DB.DTO.UserDTO">
SELECT TOP 10 [Id]
      ,[Username]
      ,[Password]
      ,[UUID]
      ,[LastLogin]
      ,[Nick]
  FROM [IHMHdb].[dbo].[User]
  Where [Username]=#{id} And [Password]=#{pw}
    </select>

    <select id="searchImage" resultType="DB.DTO.ImageDTO" parameterType="String">
      SELECT
      [AlbumImage]
  FROM [IHMHdb].[dbo].[Music]
  where [Id]=#{id}
    </select>

    <select id="test" parameterType="java.lang.String" resultType="DB.DTO.testDTO">
        SELECT
            [Title],
	        [AlbumName]
          FROM [IHMHdb].[dbo].[Music]
          WHERE [Title] =#{Title}
    </select>

    <select id="searchHistory" parameterType="DB.DTO.searchOffsetDTO" resultType="DB.DTO.HistroyDTO" >
    Select   C.Title, C.AlbumName,C.Artist,B.SearchDate,B.Location.Long as Longtitude, B.Location.Lat as Latitude, B.MusicId
     From
     [IHMHdb].[dbo].[User] as A Inner JOIN [IHMHdb].[dbo].[SearchHistory] as B on A.[Id] = B.[UserId]
     Inner Join [IHMHdb].[dbo].[Music] as C on B.MusicId = C.Id

     Where A.Username=#{id} order by B.SearchDate desc
        	OFFSET #{offset} ROWS
	FETCH NEXT #{limit} ROWS ONLY;
    </select>


    <select id="searchmobileHistory" parameterType="java.lang.String" resultType="DB.DTO.mobileHistoryDTO" >
        Select  C.Title, C.AlbumName,C.Artist,B.SearchDate,B.Location.Long as Longtitude, B.Location.Lat as Latitude, B.MusicId
        From
        [IHMHdb].[dbo].[User] as A Inner JOIN [IHMHdb].[dbo].[SearchHistory] as B on A.[Id] = B.[UserId]
        Inner Join [IHMHdb].[dbo].[Music] as C on B.MusicId = C.Id

        Where A.Username=#{id} order by B.SearchDate desc
    </select>

    <select id="getIdList" parameterType="java.lang.String" resultType="java.lang.String">
    SELECT
      [Username]
    FROM [IHMHdb].[dbo].[User]
    where [Username]=#{id}
    </select>

    <insert id="uploadHistory" parameterType="DB.DTO.UploadHistoryDTO">

    INSERT INTO [IHMHdb].[dbo].[SearchHistory]
               ([UserId]
               ,[MusicId]
               ,[Location]
               ,[SearchDate])
         VALUES
               (
               (select top 1 [IHMHdb].[dbo].[User].[Id] from [IHMHdb].[dbo].[User] where [IHMHdb].[dbo].[User].[Username]=#{id})
               ,#{musicIdx}
               ,geography::STGeomFromText('POINT('+ cast(#{latitude} as varchar(20))+' '+ cast(#{longitude} as varchar(20))+')', 4326)
               ,SYSDATETIME())

    </insert>
</mapper>